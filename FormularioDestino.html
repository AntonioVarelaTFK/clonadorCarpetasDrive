<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .contenedor {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 460px;
      }

      h2 {
        text-align: center;
        margin-bottom: 20px;
      }

      label {
        font-weight: bold;
        margin-top: 15px;
        display: block;
      }

      input, button {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      button {
        background-color: #4285F4;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #3367D6;
      }

      .spinner {
        display: none;
        margin: 20px auto;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #4285F4;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: girar 1s linear infinite;
      }

      @keyframes girar {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      #resultado {
        margin-top: 20px;
        font-size: 0.95em;
        text-align: left;
      }

      .nota {
        font-size: 0.9em;
        color: #666;
        text-align: center;
        margin-top: -10px;
        margin-bottom: 15px;
      }

      .mensaje-ok {
        background-color: #e8f5e9;
        color: #1b5e20;
        padding: 10px;
        border-left: 4px solid #2e7d32;
        border-radius: 4px;
      }

      .mensaje-error {
        background-color: #ffebee;
        color: #b71c1c;
        padding: 10px;
        border-left: 4px solid #c62828;
        border-radius: 4px;
      }

      .mensaje-aviso {
        background-color: #fff8e1;
        color: #e65100;
        padding: 10px;
        border-left: 4px solid #f9a825;
        border-radius: 4px;
      }

      .mensaje-info {
        background-color: #e3f2fd;
        color: #0d47a1;
        padding: 10px;
        border-left: 4px solid #2196f3;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="contenedor">
      <h2>Copia desde carpeta compartida</h2>

      <label for="idCarpeta">ID de la carpeta compartida:</label>
      <input type="text" id="idCarpeta" placeholder="Ej: 1a2b3c4d5e...">

      <label for="nombreDestino">Nombre de la carpeta destino:</label>
      <input type="text" id="nombreDestino" placeholder="Ej: Copia IA 2¬∫ESO...">

      <p class="nota">La copia se reanudar√° autom√°ticamente si ya existe contenido.<br>No se sobrescriben ni se duplican archivos.</p>

      <button onclick="enviar()">üìÅ Ejecutar copia</button>
      <button onclick="verificar()">üîç Verificar integridad</button>
      <button onclick="limpiar()">üßπ Limpiar destino</button>

      <div class="spinner" id="spinner"></div>
      <div id="resultado"></div>
      <div id="estadoProgreso" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
      <div id="estadoCompresionProgreso" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>


    <script>
      const POLLING_INTERVAL_MS = 7000; // Consultar estado cada 7 segundos
      
      let pollingIntervalId = null;
      let nombreDestinoGlobal = ""; // Para usar en funciones de comprimir, etc.
      
      let pollingIntervalCompresionId = null;
      let nombreLogCompresionGlobal = null; // Para seguir el log de compresi√≥n

      function verificar() {
        const datos = {
          idCarpeta: document.getElementById("idCarpeta").value.trim(),
          nombreDestino: document.getElementById("nombreDestino").value.trim() || nombreDestinoGlobal
        };
        // No actualizamos nombreDestinoGlobal aqu√≠, solo lo usamos si el campo est√° vac√≠o.
        // Si el usuario lo cambia, esa ser√° la nueva referencia para esta operaci√≥n.

        if (!datos.idCarpeta || !datos.nombreDestino) {
          mostrarResultado("<div class='mensaje-error'>Introduce el ID de carpeta y nombre destino para verificar.</div>");
          return;
        }

        mostrarSpinner(true);
        deshabilitarBotones(true);
        document.getElementById("estadoProgreso").innerHTML = ""; // Limpiar progreso anterior
        mostrarResultado("üîé Verificando integridad...");

        google.script.run
          .withSuccessHandler(function (res) { // res es ahora un objeto
            mostrarSpinner(false);
            // Guardar IDs globales que devuelve verificarIntegridad
            idDestinoGlobal = res.idDestino || null;
            urlRegistroGlobal = res.urlRegistro || null;
            nombreDestinoGlobal = res.nombreDestino || datos.nombreDestino;


            let claseResultado = "mensaje-info"; // Default
            if (res.esCoincidente) {
                claseResultado = "mensaje-ok";
            } else if (res.mensaje.includes("‚ùå") || res.mensaje.includes("Error")) {
                claseResultado = "mensaje-error";
            } else if (res.mensaje.includes("‚ö†")) {
                claseResultado = "mensaje-aviso";
            }
            
            mostrarResultado(`<div class="${claseResultado}">${res.mensaje}</div>`);

            if (res.idDestino) { // Solo agregar botones si tenemos al menos el idDestino
                agregarBotonesPostProceso(res.idDestino, res.urlRegistro, res.nombreDestino, res.esCoincidente);
            }
            deshabilitarBotones(false); // Habilitar botones despu√©s de la verificaci√≥n
          })
          .withFailureHandler(function(err){
            mostrarSpinner(false);
            deshabilitarBotones(false);
            mostrarResultado(`<div class="mensaje-error">Error al verificar: ${err.message}</div>`);
          })
          .verificarIntegridad(datos);
      }

      function enviar() {
        const datos = {
          idCarpeta: document.getElementById("idCarpeta").value.trim(),
          nombreDestino: document.getElementById("nombreDestino").value.trim(),
          modo: "auto"
        };
        nombreDestinoGlobal = datos.nombreDestino;

        if (!datos.idCarpeta) {
          mostrarResultado("<div class='mensaje-error'>Por favor, introduce un ID de carpeta origen.</div>");
          return;
        }
        if (!datos.nombreDestino) {
          mostrarResultado("<div class='mensaje-error'>Por favor, introduce un nombre para la carpeta destino.</div>");
          return;
        }

        mostrarSpinner(true);
        deshabilitarBotones(true); 
        mostrarResultado("üöÄ Iniciando comunicaci√≥n con el servidor..."); 
        document.getElementById("estadoProgreso").innerHTML = "";


        google.script.run
          .withSuccessHandler(function (res) {
            mostrarSpinner(false);
            // Guardar IDs y URLs globales si el proceso las devuelve, incluso si no fue por lotes
            idDestinoGlobal = res.idDestino || null;
            urlRegistroGlobal = res.urlRegistro || null;

            if (res.procesoPorLotesIniciado) {
              mostrarResultado(''); 
              iniciarSondeoDeEstado(res.nombreDestino); // nombreDestino se pasa para consistencia en agregarBotonesPostProceso
            } else {
              let claseMensaje = "mensaje-ok";
              if (!res.mensaje || res.mensaje.includes("‚ùå") || res.mensaje.includes("Error")) {
                claseMensaje = "mensaje-error";
              }
              mostrarResultado(`<div class="${claseMensaje}">${res.mensaje || "El proceso no se inici√≥ o ya finaliz√≥. Verifique la configuraci√≥n."}</div>`);
              if (idDestinoGlobal && urlRegistroGlobal) { 
                 agregarBotonesPostProceso(idDestinoGlobal, urlRegistroGlobal, res.nombreDestino, claseMensaje === "mensaje-ok");
              }
              deshabilitarBotones(false); 
            }
          })
          .withFailureHandler(function(err) {
            mostrarSpinner(false);
            deshabilitarBotones(false);
            mostrarResultado(`<div class="mensaje-error">Error al contactar el servidor: ${err.message}</div>`);
            document.getElementById("estadoProgreso").innerHTML = "";
          })
          .iniciarCopiaPorLotes(datos);
      }

      function iniciarSondeoDeEstado(nombreDestino) {
        if (pollingIntervalId) {
          clearInterval(pollingIntervalId);
        }
        // Llamada inmediata para obtener el primer estado r√°pido
        // y asegurarse que deshabilitarBotones(true) se aplique si no lo hizo antes
        deshabilitarBotones(true); 
        consultarEstado(nombreDestino); 
        pollingIntervalId = setInterval(function() { consultarEstado(nombreDestino); }, POLLING_INTERVAL_MS);
      }

      function consultarEstado(nombreDestino) {
        const dest = nombreDestino || nombreDestinoGlobal;
        google.script.run
          .withSuccessHandler(function(estado) {
            actualizarUIEstado(estado, dest);
          })
          .withFailureHandler(function(err) {
            const estadoHtml = document.getElementById("estadoProgreso");
            // No mostrar un mensaje de error muy intrusivo aqu√≠, ya que puede ser temporal
            // y se sobreescribir√° con el siguiente sondeo exitoso.
            if (estadoHtml.innerHTML.includes("mensaje-info")) { // Solo a√±adir si ya hay un mensaje de progreso
                estadoHtml.innerHTML += `<div class="mensaje-aviso" style="font-size:0.8em; opacity:0.7;">(Fallo temporal al actualizar estado)</div>`;
            }
            console.warn("Fallo temporal al consultar estado:", err);
          })
          .obtenerEstadoCopia();
      }


     
      // Modificado para aceptar un flag 'exitoso' para el bot√≥n de comprimir
      function agregarBotonesPostProceso(idDestino, urlRegistro, nombreDestino, exitoso) {
          const resultadoDiv = document.getElementById("resultado");
          let botonesHtmlBase = `
            <div style="text-align: center; margin-top: 20px;">
              <button onclick="window.open('https://drive.google.com/drive/folders/${idDestino}', '_blank')" style="margin-top:10px">
                Abrir carpeta en Drive
              </button><br><br>
              <button onclick="window.open('${urlRegistro}', '_blank')" style="margin-top:5px">
                Ver archivo de progreso
              </button>
            </div>
          `;
          
          if (exitoso) { // Solo mostrar bot√≥n de comprimir si la copia fue completamente exitosa
              google.script.run
                .withSuccessHandler(function(estimado){
                   let estimacionHtml = `<div class="mensaje-info" style="margin-top:10px;">${estimado.mensaje}</div>`;
                   let botonComprimirHtml = `
                    ${estimacionHtml}
                    <div style="text-align:center; margin-top: 15px;">
                      <button onclick="comprimir('${nombreDestino}')" style="background-color:#6d4c41;">
                        üóúÔ∏è Comprimir carpeta destino en ZIP(s)
                      </button>
                    </div>`;
                   resultadoDiv.innerHTML += botonesHtmlBase + botonComprimirHtml;
                })
                .withFailureHandler(function(err){
                    resultadoDiv.innerHTML += botonesHtmlBase; // A√±adir solo botones b√°sicos si falla estimaci√≥n
                    console.error("Error al obtener estimaci√≥n de compresi√≥n: ", err);
                })
                .calcularEstimacionCompresion(nombreDestino);
          } else {
              resultadoDiv.innerHTML += botonesHtmlBase; 
          }
      }

      function mostrarSpinner(visible) {
        document.getElementById("spinner").style.display = visible ? "block" : "none";
      }

      function mostrarResultado(html) {
        document.getElementById("resultado").innerHTML = html;
      }

      function deshabilitarBotones(deshabilitar) {
        const selectoresBotones = [
          "button[onclick='enviar()']",
          "button[onclick='verificar()']",
          "button[onclick='limpiar()']"
        ];
        selectoresBotones.forEach(selector => {
          const boton = document.querySelector(selector);
          if (boton) {
            boton.disabled = deshabilitar;
          } else {
            // Puede que el bot√≥n a√∫n no exista si es la primera carga, no es un error cr√≠tico.
            console.warn("Advertencia: No se encontr√≥ el bot√≥n con selector:", selector, "para (des)habilitar.");
          }
        });
        // El bot√≥n de comprimir se maneja aparte ya que se a√±ade din√°micamente.
        // Si existe, tambi√©n lo (des)habilitamos.
        const botonComprimir = document.querySelector("button[onclick^='comprimir(']"); // Busca onclick que empiece con 'comprimir('
        if (botonComprimir) {
            botonComprimir.disabled = deshabilitar;
        }
      }

      function limpiar() {
        const datos = {
          idCarpeta: document.getElementById("idCarpeta").value.trim(),
          nombreDestino: document.getElementById("nombreDestino").value.trim() || nombreDestinoGlobal
        };
        nombreDestinoGlobal = datos.nombreDestino;

        if (!datos.idCarpeta || !datos.nombreDestino) {
          mostrarResultado("<div class='mensaje-error'>Introduce el ID de carpeta y nombre destino para limpiar.</div>");
          return;
        }

        if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar los elementos sobrantes del destino? Esta acci√≥n no se puede deshacer.")) {
          return;
        }

        mostrarSpinner(true);
        deshabilitarBotones(true);
        document.getElementById("estadoProgreso").innerHTML = "";
        mostrarResultado("üßπ Limpiando destino...");

        google.script.run
          .withSuccessHandler(function (res) {
            mostrarSpinner(false);
            deshabilitarBotones(false);
            let claseResultado = res.includes("‚úÖ") ? "mensaje-ok" :
                                 res.includes("‚ùå") ? "mensaje-error" :
                                 "mensaje-aviso";
            mostrarResultado(`<div class="${claseResultado}">${res}</div>`);
          })
           .withFailureHandler(function(err){
            mostrarSpinner(false);
            deshabilitarBotones(false);
            mostrarResultado(`<div class="mensaje-error">Error al limpiar: ${err.message}</div>`);
          })
          .limpiarDestino(datos);
      }

      function actualizarUIEstado(estado, nombreDestino) { 
          const estadoHtml = document.getElementById("estadoProgreso");
          const resultadoHtml = document.getElementById("resultado");
          let progresoMensaje = "";

          // Guardar IDs actualizados que vienen del sondeo
          if(estado.idDestino) idDestinoGlobal = estado.idDestino;
          if(estado.urlRegistro) urlRegistroGlobal = estado.urlRegistro;

          if (estado.procesoActivo) {
            mostrarSpinner(true); 
            deshabilitarBotones(true); 
            // Asegurar que los botones de compresi√≥n tambi√©n est√©n deshabilitados si el proceso de copia est√° activo
            const botonComprimir = document.querySelector("button[onclick^='comprimir(']");
            if (botonComprimir) botonComprimir.disabled = true;

            if (estado.progreso) {
              progresoMensaje = `<div>${estado.mensaje || "Procesando copia..."}</div>`;
              if (estado.progreso.totalTareas > 0) {
                const porcentaje = estado.progreso.totalTareas > 0 ?
                                    Math.round((estado.progreso.tareasCompletadas / estado.progreso.totalTareas) * 100) : 0;
                progresoMensaje += `
                  <div style="margin-top: 5px;">
                    Tareas de copia: ${estado.progreso.tareasCompletadas} de ${estado.progreso.totalTareas} (${porcentaje}%)
                  </div>
                  <div style="background-color: #e0e0e0; border-radius: 4px; padding: 2px; margin-top: 5px;">
                    <div style="width: ${porcentaje}%; background-color: #4285F4; color: white; text-align: center; border-radius: 2px; padding: 1px 0;">
                      ${porcentaje >= 5 ? porcentaje + '%' : ''}
                    </div>
                  </div>
                `;
              }
              if (estado.progreso.erroresEnLote > 0 || (estado.errores && estado.errores.length > 0)) {
                  progresoMensaje += `<div style="color: #c62828; margin-top: 5px;">Errores detectados durante la copia.</div>`;
              }
            } else {
              progresoMensaje = `<div>${estado.mensaje || "Esperando estado de copia..."}</div>`;
            }
            estadoHtml.innerHTML = `<div class="mensaje-info">${progresoMensaje}</div>`;
            document.getElementById("estadoCompresionProgreso").innerHTML = ""; // Limpiar estado de compresi√≥n si la copia est√° activa
            resultadoHtml.innerHTML = ''; 

          } else { // Proceso de copia NO activo
            if (!pollingIntervalCompresionId) { // Solo detener spinner y habilitar botones si la compresi√≥n TAMPOCO est√° activa
                mostrarSpinner(false);
                deshabilitarBotones(false); 
            }
            clearInterval(pollingIntervalId);
            pollingIntervalId = null;
            
            estadoHtml.innerHTML = ""; 

            let mensajeFinal = "";
            let claseFinal = "mensaje-info"; 

            if (estado.estadoGeneral === "completado_ok") {
                mensajeFinal = estado.mensaje || "‚úÖ Proceso de copia completado exitosamente.";
                claseFinal = "mensaje-ok";
            } else if (estado.estadoGeneral === "completado_con_errores") {
                mensajeFinal = estado.mensaje || "üü° Proceso de copia completado con errores.";
                claseFinal = "mensaje-aviso";
            } else if (estado.estadoGeneral === "error_critico") {
                mensajeFinal = estado.mensaje || "‚ùå Error cr√≠tico durante el proceso de copia.";
                claseFinal = "mensaje-error";
            } else {
                mensajeFinal = estado.mensaje || "El estado del proceso de copia no es concluyente o no hay informaci√≥n reciente.";
                if (mensajeFinal.includes("Error") || mensajeFinal.includes("fallo")) claseFinal = "mensaje-error";
                else if (mensajeFinal.includes("No hay ning√∫n proceso")) claseFinal = "mensaje-info"; 
                else claseFinal = "mensaje-aviso";
            }
            
            // Solo actualizar #resultado si no hay un proceso de compresi√≥n mostrando su propio resultado final.
            if (!document.getElementById("estadoCompresionProgreso").innerHTML.includes("mensaje-")) {
              resultadoHtml.innerHTML = `<div class="${claseFinal}">${mensajeFinal}</div>`;
            }
            
            if (urlRegistroGlobal && (estado.estadoGeneral === "completado_ok" || estado.estadoGeneral === "completado_con_errores")) {
                agregarBotonesPostProceso(idDestinoGlobal, urlRegistroGlobal, nombreDestino || nombreDestinoGlobal, estado.estadoGeneral === "completado_ok");
            }
            if (!pollingIntervalCompresionId) { // Solo habilitar si la compresi√≥n no est√° activa
                deshabilitarBotones(false); 
            }
          }
      }

      function comprimir(nombreDestino) { 
          const dest = nombreDestino || nombreDestinoGlobal;
          if (!dest) {
            mostrarResultado("<div class='mensaje-error'>Falta el nombre de la carpeta destino para comprimir.</div>");
            return;
          }

          mostrarSpinner(true);
          deshabilitarBotones(true); 
          document.getElementById("estadoProgreso").innerHTML = ""; // Limpiar estado de copia
          document.getElementById("estadoCompresionProgreso").innerHTML = `<div class="mensaje-info">üöÄ Iniciando compresi√≥n para "${dest}"...</div>`;
          mostrarResultado(""); // Limpiar resultado principal

          google.script.run
              .withSuccessHandler(function (resInicioCompresion) {
                // No ocultar spinner aqu√≠, el sondeo lo manejar√°
                if (resInicioCompresion.compresionPorLotesIniciada) {
                  nombreLogCompresionGlobal = resInicioCompresion.logFileName; // Guardar para sondeo
                  document.getElementById("estadoCompresionProgreso").innerHTML = `<div class="mensaje-info">${resInicioCompresion.mensaje}</div>`;
                  iniciarSondeoEstadoCompresion(dest);
                } else {
                  mostrarSpinner(false);
                  deshabilitarBotones(false);
                  document.getElementById("estadoCompresionProgreso").innerHTML = "";
                  mostrarResultado(`<div class="mensaje-error">${resInicioCompresion.mensaje || "No se pudo iniciar la compresi√≥n."}</div>`);
                }
              })
              .withFailureHandler(function(err){
                  mostrarSpinner(false);
                  deshabilitarBotones(false);
                  document.getElementById("estadoCompresionProgreso").innerHTML = "";
                  mostrarResultado(`<div class="mensaje-error">Error al iniciar compresi√≥n: ${err.message}</div>`);
              })
              .iniciarCompresionPorLotes(dest);
      }

      function iniciarSondeoEstadoCompresion(nombreDestino) {
          if (pollingIntervalCompresionId) {
            clearInterval(pollingIntervalCompresionId);
          }
          deshabilitarBotones(true); // Asegurar que est√©n deshabilitados
          consultarEstadoCompresion(nombreDestino); // Llamada inmediata
          pollingIntervalCompresionId = setInterval(function() { consultarEstadoCompresion(nombreDestino); }, POLLING_INTERVAL_MS);
      }

      function consultarEstadoCompresion(nombreDestino) {
          google.script.run
            .withSuccessHandler(function(estado) {
              actualizarUIEstadoCompresion(estado, nombreDestino);
            })
            .withFailureHandler(function(err) {
              const estadoHtmlComp = document.getElementById("estadoCompresionProgreso");
              if (estadoHtmlComp.innerHTML.includes("mensaje-info")) {
                  estadoHtmlComp.innerHTML += `<div class="mensaje-aviso" style="font-size:0.8em; opacity:0.7;">(Fallo temporal al actualizar estado de compresi√≥n)</div>`;
              }
              console.warn("Fallo temporal al consultar estado de compresi√≥n:", err);
            })
            .obtenerEstadoCompresion(); // No necesita 'nombreDestino' si el log se gestiona por Properties
      }

      function actualizarUIEstadoCompresion(estado, nombreDestinoOriginal) {
          const estadoHtmlComp = document.getElementById("estadoCompresionProgreso");
          const resultadoHtml = document.getElementById("resultado"); // Para mensajes finales
          let progresoMensaje = "";

          if (estado.procesoCompresionActivo) {
            mostrarSpinner(true);
            deshabilitarBotones(true);
            if (estado.progresoCompresion) {
              progresoMensaje = `<div>${estado.mensaje || "Comprimiendo..."}</div>`;
              const prog = estado.progresoCompresion;
              if (prog.totalArchivosAComprimir > 0) {
                const porcentajeArchivos = prog.totalArchivosAComprimir > 0 ?
                                  Math.round((prog.archivosConvertidosABlob / prog.totalArchivosAComprimir) * 100) : 0;
                progresoMensaje += `
                  <div style="margin-top: 5px;">
                    Archivos preparados: ${prog.archivosConvertidosABlob} de ${prog.totalArchivosAComprimir} (${porcentajeArchivos}%)
                  </div>
                  <div style="background-color: #e0e0e0; border-radius: 4px; padding: 2px; margin-top: 2px;">
                    <div style="width: ${porcentajeArchivos}%; background-color: #6d4c41; color: white; text-align: center; border-radius: 2px; padding: 1px 0;">
                      ${porcentajeArchivos >= 5 ? porcentajeArchivos + '%' : ''}
                    </div>
                  </div>`;
              }
              progresoMensaje += `<div style="font-size:0.9em; margin-top:3px;">ZIP actual: Parte ${prog.zipPartsCreados + 1} de ${prog.zipPartsEstimados || '?'}. Archivos en ZIP actual: ${prog.archivosEnZipActual || 0}.</div>`;

              if (estado.erroresCompresion && estado.erroresCompresion.length > 0) {
                progresoMensaje += `<div style="color: #c62828; margin-top: 5px;">Errores durante la compresi√≥n.</div>`;
              }
            } else {
              progresoMensaje = `<div>${estado.mensaje || "Esperando estado de compresi√≥n..."}</div>`;
            }
            estadoHtmlComp.innerHTML = `<div class="mensaje-info">${progresoMensaje}</div>`;
            resultadoHtml.innerHTML = ''; // Limpiar resultado principal mientras la compresi√≥n est√° activa

          } else { // Proceso de compresi√≥n NO activo
            mostrarSpinner(false); // Ocultar spinner si la copia tampoco est√° activa
            if (!pollingIntervalId) deshabilitarBotones(false); // Habilitar si la copia no est√° corriendo

            clearInterval(pollingIntervalCompresionId);
            pollingIntervalCompresionId = null;
            
            estadoHtmlComp.innerHTML = ""; // Limpiar el √°rea de progreso de compresi√≥n

            let mensajeFinal = "";
            let claseFinal = "mensaje-info";

            if (estado.estadoGeneralCompresion === "completado_ok") {
                mensajeFinal = estado.mensaje || "‚úÖ Compresi√≥n completada exitosamente.";
                claseFinal = "mensaje-ok";
            } else if (estado.estadoGeneralCompresion === "completado_con_errores") {
                mensajeFinal = estado.mensaje || "üü° Compresi√≥n completada con errores o advertencias.";
                claseFinal = "mensaje-aviso";
            } else if (estado.estadoGeneralCompresion === "error_critico") {
                mensajeFinal = estado.mensaje || "‚ùå Error cr√≠tico durante la compresi√≥n.";
                claseFinal = "mensaje-error";
            } else {
                mensajeFinal = estado.mensaje || "El estado de la compresi√≥n no es concluyente.";
                if (mensajeFinal.includes("Error") || mensajeFinal.includes("fallo")) claseFinal = "mensaje-error";
                else claseFinal = "mensaje-info";
            }
            
            let htmlResFinal = `<div class="${claseFinal}">${mensajeFinal}</div>`;

            if (estado.zipsGenerados && estado.zipsGenerados.length > 0 && estado.urlCarpetaZips) {
              htmlResFinal += `
                <div style="text-align: center; margin-top: 15px; margin-bottom:10px;">
                  <button onclick="window.open('${estado.urlCarpetaZips}', '_blank')" style="margin-top:5px; background-color:#388e3c;">
                    üóÇÔ∏è Abrir carpeta con ZIPs
                  </button>
                </div>`;
            }
            if (estado.urlLogCompresion) {
              htmlResFinal += `
                <div style="text-align: center; margin-bottom:15px;">
                  <button onclick="window.open('${estado.urlLogCompresion}', '_blank')" style="margin-top:5px; font-size:0.9em; padding: 8px;">
                    Ver log de compresi√≥n
                  </button>
                </div>`;
            }
            if (estado.advertenciasCompresion && estado.advertenciasCompresion.length > 0) {
              htmlResFinal += `<div class="mensaje-aviso" style="font-size:0.85em; margin-top:10px;"><strong>Advertencias:</strong><br>${estado.advertenciasCompresion.join('<br>')}</div>`;
            }
            if (estado.erroresCompresion && estado.erroresCompresion.length > 0) {
              htmlResFinal += `<div class="mensaje-error" style="font-size:0.85em; margin-top:10px;"><strong>Errores Detallados:</strong><br>${estado.erroresCompresion.map(e => `Archivo: ${e.archivo} - ${e.mensaje}`).join('<br>')}</div>`;
            }

            resultadoHtml.innerHTML = htmlResFinal; // Mostrar resultado final de la compresi√≥n
            // Re-habilitar botones si el proceso de copia no est√° activo
            if (!pollingIntervalId) {
                deshabilitarBotones(false);
            }
          }
      }

      window.onload = function() {
          mostrarSpinner(false);
          deshabilitarBotones(false);
          // Podr√≠as incluso llamar a obtenerEstadoCopia y obtenerEstadoCompresion
          // para reanudar la visualizaci√≥n si se recarga la p√°gina y un proceso estaba activo.
          // Por simplicidad, no lo a√±ado ahora, pero es una mejora posible.
      }

    </script>
  </body>
</html>
